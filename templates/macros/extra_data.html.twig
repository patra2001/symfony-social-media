{% macro extra_data(form, extra_fields, form_id) %}
    {# Hidden field (Symfony form field) #}
    <div class="mb-3">
        <label class="form-label">Additional data</label>
        <div id="extraPicker_{{ form_id }}" class="border rounded p-3" style="cursor:pointer; min-height:48px;">
            <small class="text-muted" id="extraPreview_{{ form_id }}">Additional data</small>
        </div>
    </div>

    {# Modal for editing extra data #}
    <div class="modal fade" id="extraModal_{{ form_id }}" tabindex="-1" aria-labelledby="extraModalLabel_{{ form_id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="extraModalLabel_{{ form_id }}">Edit Extra Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="extraForm_{{ form_id }}">
                        <div id="extraFieldsContainer_{{ form_id }}"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="extraForm_{{ form_id }}" class="btn btn-primary">Submit</button>
                </div>
            </div>
        </div>
    </div>

    {# JS block scoped to this macro instance #}
    <script>
    (function () {
        // Scope element ids using the provided form_id so multiple forms on the page work.
        const formEl = document.getElementById('{{ form_id }}');
        const extraPicker = document.getElementById('extraPicker_{{ form_id }}');
        const extraPreview = document.getElementById('extraPreview_{{ form_id }}');
        const hiddenExtra = formEl ? formEl.querySelector('[name="post[extraData]"]') : null;

    // Read extra fields provided by the server via window.__POST_CONFIG__ (set by the template)
    const extraFields = (window.__POST_CONFIG__ && window.__POST_CONFIG__.extra_fields) ? window.__POST_CONFIG__.extra_fields : {};

        function formatPreview(data) {
            if (!data || !Object.keys(data).length) return 'Click to add web url, data and others';
            let html = '';
            for (let key in data) {
                const rawName = key.replace(/_/g, '-');
                html += rawName + ': ' + data[key] + '<br>';
            }
            return html;
        }

        // Only wire up the extra-data UI if the elements exist in the DOM.
        if (extraPicker && extraPreview) {
            try {
                let initial = {};
                const firstKey = Object.keys(extraFields)[0];
                const group = extraFields[firstKey] || {};
                for (let rawName in group) {
                    const key = rawName.replace(/-/g, '_');
                    initial[key] = group[rawName];
                }
                if (hiddenExtra && hiddenExtra.value) {
                    initial = JSON.parse(hiddenExtra.value);
                }
                extraPreview.innerHTML = formatPreview(initial);
                if (hiddenExtra && !hiddenExtra.value && initial && Object.keys(initial).length) hiddenExtra.value = JSON.stringify(initial);
            } catch (e) {
                // ignore
            }

            extraPicker.addEventListener('click', function () {
                const firstKey = Object.keys(extraFields)[0];
                const group = extraFields[firstKey] || {};
                const current = (hiddenExtra && hiddenExtra.value) ? JSON.parse(hiddenExtra.value) : {};

                const container = document.getElementById('extraFieldsContainer_{{ form_id }}');
                if (!container) return;
                container.innerHTML = '';

                Object.keys(group).forEach(rawName => {
                    const key = rawName.replace(/-/g, '_');
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'mb-3';

                    const label = document.createElement('label');
                    label.className = 'form-label';
                    label.textContent = rawName;
                    label.setAttribute('for', `extra_${key}_{{ form_id }}`);

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control';
                    input.id = `extra_${key}_{{ form_id }}`;
                    input.name = key;
                    input.value = current[key] || group[rawName];

                    fieldDiv.appendChild(label);
                    fieldDiv.appendChild(input);
                    container.appendChild(fieldDiv);
                });

                // Show modal (guarded in case modal markup is absent)
                const modalEl = document.getElementById('extraModal_{{ form_id }}');
                if (modalEl) {
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                }
            });

            const extraFormEl = document.getElementById('extraForm_{{ form_id }}');
            if (extraFormEl) {
                extraFormEl.addEventListener('submit', function (event) {
                    event.preventDefault();

                    const formData = new FormData(event.target);
                    const payload = {};
                    for (let [key, value] of formData.entries()) {
                        payload[key] = value;
                    }

                    const json = JSON.stringify(payload);
                    if (hiddenExtra) hiddenExtra.value = json;
                    extraPreview.innerHTML = formatPreview(payload);

                    // Hide modal
                    const modalInstanceEl = document.getElementById('extraModal_{{ form_id }}');
                    if (modalInstanceEl) {
                        const modal = bootstrap.Modal.getInstance(modalInstanceEl);
                        if (modal) modal.hide();
                    }
                });
            }
        }
    })();
    </script>
{% endmacro %}
